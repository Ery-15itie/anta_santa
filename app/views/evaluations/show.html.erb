<%# 評価詳細画面: 机の上の手紙 - バランス調整したった %>

<div class="min-h-screen bg-[#271c19] font-serif pb-20 relative overflow-x-hidden text-[#3e2723]">
  
  <%# 背景: 重厚な木の机のテクスチャ %>
  <div class="fixed inset-0 opacity-40 pointer-events-none" 
       style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjM2UyNzIzIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMiIvPgo8L3N2Zz4=');">
  </div>
  <div class="fixed inset-0 pointer-events-none shadow-[inset_0_0_150px_rgba(0,0,0,0.8)]"></div>

  <div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
    
    <%# --- 1. 戻るボタン --- %>
    <div class="mb-8 text-left relative pl-2">
       <%= link_to evaluations_path, class: "inline-block group relative" do %>
         <div class="absolute -top-12 left-4 w-0.5 h-16 bg-[#8d6e63]"></div>
         <div class="bg-[#4e342e] border-2 border-[#3e2723] px-5 py-2 rounded shadow-lg transform group-hover:-translate-y-1 transition duration-300 flex items-center gap-2">
           <span class="text-[#ffecb3] text-lg">↩</span>
           <span class="text-[#ffecb3] font-bold text-sm tracking-widest">Mailboxに戻る</span>
         </div>
       <% end %>
    </div>
    
    <%# --- 2. 便箋エリア --- %>
    <div class="bg-[#fffdf5] p-8 sm:p-12 shadow-[0_20px_50px_rgba(0,0,0,0.5)] relative rounded-sm transform rotate-[0.5deg] mx-auto max-w-3xl overflow-hidden">
      
      <%# 紙の質感 %>
      <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');"></div>
      <div class="absolute inset-0 pointer-events-none shadow-[inset_0_0_60px_rgba(161,136,127,0.2)]"></div>

      <%# ヘッダー: 宛名と消印 (バランス調整) %>
      <div class="flex flex-col sm:flex-row justify-start items-start gap-4 sm:gap-10 mb-10 relative z-10 border-b-2 border-[#3e2723] pb-6">
        
        <%# 宛名書き (左側メイン) %>
        <div class="flex-grow relative z-10">
          <p class="text-xs font-bold text-[#8d6e63] tracking-widest uppercase mb-1">Dear</p>
          <h1 class="text-4xl font-black text-[#3e2723] font-serif mb-2 leading-tight break-words">
            <%= @evaluation.evaluated_user.username %>
          </h1>
          <div class="flex items-center gap-2 text-sm text-[#5d4037] font-medium">
             <span>FROM:</span>
             <span class="border-b border-dotted border-[#8d6e63] px-2"><%= @evaluation.evaluator.username %></span>
          </div>
        </div>

        <%# 消印 (日付) - 位置を調整して宛名に寄せる %>
        <div class="relative transform rotate-[-12deg] opacity-90 flex-shrink-0 sm:-ml-8 sm:mt-1 z-0" style="mix-blend-mode: multiply;">
          <div class="w-24 h-24 rounded-full border-4 border-[#d32f2f] flex flex-col items-center justify-center text-[#d32f2f] font-bold tracking-widest p-1">
             <span class="text-[10px] border-b border-[#d32f2f]">ANTA-SANTA</span>
             <span class="text-lg font-mono my-1"><%= l(@evaluation.created_at, format: "%b %d") %></span>
             <span class="text-xs"><%= l(@evaluation.created_at, format: "%Y") %></span>
          </div>
          <div class="absolute top-1/2 -right-12 w-12 h-4 border-t-2 border-b-2 border-[#d32f2f]"></div>
        </div>
      </div>

      <%# メッセージ本文 %>
      <div class="mb-12 relative z-10">
        <h2 class="text-sm font-bold text-[#8d6e63] mb-2 uppercase tracking-wider flex items-center gap-2">
          <span>Message</span>
          <span class="h-px flex-grow bg-[#d7ccc8]"></span>
        </h2>
        
        <div class="text-lg sm:text-xl text-[#1a237e] font-serif leading-loose whitespace-pre-wrap relative pt-1 px-2"
             style="background-image: linear-gradient(transparent 1.9rem, #e0e0e0 2rem); background-size: 100% 2rem; line-height: 2rem;">
          <%= @evaluation.message %>
        </div>
      </div>
      
      <%# 良いところリスト (クリップ止めメモ風) %>
      <% @checked_scores = @evaluation.evaluation_scores.where(score: 1).includes(:template_item) %>
      
      <div class="relative z-10 mt-8 bg-[#fff8e1] p-6 shadow-md border border-[#d7ccc8] transform rotate-[-1deg] rounded-sm">
        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-8 h-12 rounded-full border-4 border-[#a1887f] bg-transparent border-b-0"></div>
        
        <div class="flex items-center justify-between mb-4 border-b border-dashed border-[#8d6e63] pb-2">
          <h2 class="text-lg font-bold text-[#5d4037]">Nice Points</h2>
          <span class="bg-[#d32f2f] text-[#ffcdd2] text-xs font-bold px-2 py-1 rounded-full shadow-sm">
            <%= @checked_scores.count %> Check!
          </span>
        </div>

        <% if @checked_scores.any? %>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <% @checked_scores.group_by { |score| score.template_item.category }.each do |category, scores_by_category| %>
              <div>
                <h3 class="text-xs font-bold text-[#fff] bg-[#8d6e63] px-2 py-0.5 rounded inline-block mb-2">
                  <%= category %>
                </h3>
                <ul class="space-y-2">
                  <% scores_by_category.each do |score| %>
                    <li class="flex items-start gap-2 text-[#4e342e] text-sm font-medium">
                      <span class="text-[#2e7d32] text-lg leading-none">✔</span>
                      <span><%= score.template_item.title %></span>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-center text-[#a1887f] text-sm italic">No specific points checked.</p>
        <% end %>
      </div>

    </div>
    
    <%# フッター情報 %>
    <div class="text-center text-[#8d6e63] text-xs font-mono mt-8 opacity-50">
      Message ID: #<%= @evaluation.id %>
    </div>

  </div>
</div>