<%# app/views/evaluations/show.html.erb %>
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <h1 class="mb-4">メッセージ詳細</h1>
      
      <%# @evaluation.evaluated_user/evaluator_user が current_user と一致するかで表示を切り替え %>
      <% is_received = @evaluation.evaluated_user == current_user %>
      
      <%# 基本情報カード (受け取りメッセージなら緑、送ったメッセージなら青) %>
      <div class="card shadow-sm mb-4 border-<%= is_received ? 'success' : 'primary' %> border-3">
        <div class="card-header bg-<%= is_received ? 'success' : 'primary' %> text-white">
          <h4 class="mb-0">
            <%= is_received ? 'From' : 'To' %>:
            <%# 評価者か評価対象者かで表示する名前を切り替える %>
            <%= is_received ? @evaluation.evaluator.display_name : @evaluation.evaluated_user.display_name %>
            さん
            <small class="float-end pt-1"><%= time_ago_in_words(@evaluation.created_at) %>前</small>
          </h4>
        </div>
        <div class="card-body">
          
          <h5 class="card-title"><%= @evaluation.title %></h5>
          
          <%# サンタさんからのお言葉（メッセージ） %>
          <div class="alert alert-light border-start border-3 border-secondary p-3 mt-3">
            <h6 class="text-secondary">サンタさんからのお言葉</h6>
            <%# 改行を有効にするために safe_join と split("\n") を使用 %>
            <p class="mb-0 message-content"><%= safe_join(@evaluation.message.split("\n"), tag(:br)) %></p>
          </div>
        </div>
      </div>
      
      <%# チェック項目リスト %>
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">チェックされた良いところ (<%= @scores.count %>個)</h5>
        </div>
        <div class="card-body p-4">
          
          <% if @scores.any? %>
            <%# コントローラでグループ化された @grouped_scores を使用 %>
            <% @grouped_scores.each do |category, scores_by_category| %>
              <div class="category-section mb-4 pb-2 border-bottom">
                <h6 class="text-primary fw-bold mb-3"><%= category %></h6>
                
                <%# サブカテゴリーでさらにグループ化 %>
                <% scores_by_category.group_by { |s| s.template_item.sub_category }.each do |sub_category, scores_by_sub_category| %>
                  <div class="sub-category-section mb-3 ms-3">
                    <h6 class="text-secondary fw-bold mb-2"><%= sub_category %></h6>
                    <ul class="list-unstyled ms-3">
                      <% scores_by_sub_category.each do |score| %>
                        <li class="mb-1">
                          <i class="bi bi-star-fill text-warning me-2"></i>
                          <%= score.template_item.title %>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted text-center">チェックされた項目はありませんでした。</p>
          <% end %>
        </div>
      </div>

      <%= link_to "← 一覧に戻る", evaluations_path, class: "btn btn-outline-secondary mt-3" %>

    </div>
  </div>
</div>