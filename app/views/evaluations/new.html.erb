<%# 評価フォーム: お手紙作成デスク  %>

<div class="min-h-screen bg-[#271c19] font-serif pb-20 relative overflow-x-hidden text-[#3e2723]">
  
  <%# 背景: 重厚な木の机のテクスチャ %>
  <div class="fixed inset-0 opacity-40 pointer-events-none" 
       style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjM2UyNzIzIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMiIvPgo8L3N2Zz4=');">
  </div>
  <%# 木目のライン %>
  <div class="fixed inset-0 opacity-10 pointer-events-none"
       style="background: repeating-linear-gradient(90deg, transparent 0, transparent 50px, rgba(0,0,0,0.2) 50px, rgba(0,0,0,0.2) 51px);">
  </div>

  <div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
    
    <%# --- 1. 戻るボタン (木の矢印看板) --- %>
    <div class="mb-8 text-left relative pl-4">
       <%= link_to users_path, class: "inline-block group relative" do %>
         <div class="absolute -top-12 left-4 w-0.5 h-12 bg-[#5d4037]"></div>
         <div class="absolute -top-12 right-4 w-0.5 h-12 bg-[#5d4037]"></div>
         <div class="bg-[#4e342e] border-2 border-[#3e2723] px-4 py-1.5 rounded shadow-lg transform group-hover:-translate-y-1 transition duration-300 flex items-center gap-2">
           <span class="text-[#ffecb3] text-lg">←</span>
           <span class="text-[#ffecb3] font-bold text-sm tracking-widest">BACK</span>
         </div>
       <% end %>
    </div>

    <%# --- メインエリア: 机の上の便箋 --- %>
    
    <%# Turboを無効化 ("data-turbo" => "false") して送信ボタンを動作させる %>
    <%= form_with model: @evaluation, url: evaluations_path, local: true, html: { class: "evaluation-form", "data-turbo" => "false" } do |f| %>

      <%# テンプレートID等の保持 %>
      <%= f.hidden_field :template_id, value: @template&.id %>
      <%= f.hidden_field :evaluated_user_id, value: @receiver.id %>

      <%# エラーメッセージ (赤いメモ用紙風) %>
      <% if @evaluation.errors.any? %>
        <div class="mb-8 bg-[#ffebee] border-l-4 border-[#c62828] p-4 shadow-md transform -rotate-1 mx-auto max-w-2xl relative">
          <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 rounded-full bg-[#b71c1c] shadow-sm border border-[#e57373]"></div>
          <h4 class="font-bold text-[#c62828] mb-2 flex items-center gap-2">
            <span>⚠️</span> 送信できませんでした
          </h4>
          <ul class="list-disc ml-5 space-y-1 text-sm text-[#b71c1c]">
            <% @evaluation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <%# 左カラム: 手紙本文 (便箋) %>
        <div class="lg:col-span-2">
          <div class="bg-[#fffdf5] p-8 shadow-2xl relative rounded-sm" style="min-height: 600px;">
            
            <%# 紙の質感 %>
            <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');"></div>
            
            <%# ヘッダー部分 %>
            <div class="text-center mb-8 relative z-10">
              <p class="text-xs font-bold text-[#8d6e63] tracking-widest uppercase mb-1">SANTA'S LETTER</p>
              <h1 class="text-3xl font-black text-[#3e2723] font-serif border-b-2 border-[#3e2723] inline-block pb-2">
                To: <%= @receiver.username %>
              </h1>
            </div>

       <%# メッセージ入力エリア (罫線便箋風) %>
            <div class="relative z-10">
              <%= f.label :message, "Message", class: "block text-sm font-bold text-[#5d4037] mb-2 uppercase tracking-wider" %>
              
              <div class="relative">
                <%# 罫線のCSSトリック %>
                <%= f.text_area :message, 
                                class: "w-full bg-transparent border-none focus:ring-0 text-lg leading-loose text-[#3e2723] font-serif resize-none p-0", 
                                rows: 12, 
                                placeholder: "日頃の感謝や、素敵なエピソードをここに記してください...",
                                style: "background-image: linear-gradient(transparent 1.9rem, #d7ccc8 2rem); background-size: 100% 2rem; line-height: 2rem;" %>
              </div>
            </div>

            <%# 羽ペン装飾 %>
            <div class="absolute bottom-4 right-4 opacity-50 pointer-events-none">
               <span class="text-6xl text-[#d7ccc8]">✒️</span>
            </div>
          </div>
        </div>

        <%# 右カラム: 評価チェックリスト (メモ帳風) & 送信ボタン %>
        <div class="lg:col-span-1 flex flex-col gap-6">
          
          <%# メモ帳 %>
          <div class="bg-[#fff8e1] p-6 shadow-xl border-t-8 border-[#8d6e63] relative rounded-b transform rotate-1">
            <h2 class="text-lg font-bold text-[#3e2723] mb-4 border-b border-dashed border-[#8d6e63] pb-2">
              Check List
              <span class="block text-[10px] font-normal text-[#8d6e63] mt-1">相手の素敵なところ (1つ以上)</span>
            </h2>

            <div class="space-y-6 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
              <% @evaluation.evaluation_scores.group_by { |es| es.template_item.category }.each do |category, scores| %>
                <div>
                  <h3 class="text-xs font-bold text-[#fff] bg-[#8d6e63] px-2 py-1 rounded inline-block mb-2"><%= category %></h3>
                  <ul class="space-y-2">
                    <% scores.each do |score_obj| %>
                      <%= f.fields_for :evaluation_scores, score_obj do |score_f| %>
                        <%= score_f.hidden_field :id %>
                        <%= score_f.hidden_field :template_item_id %>
                        
                        <li class="flex items-start gap-2 group cursor-pointer">
                          <%= score_f.check_box :score, 
                                                { class: "mt-1 h-4 w-4 text-[#5d4037] border-[#8d6e63] rounded focus:ring-[#5d4037] cursor-pointer" }, 
                                                '1', '0' %>
                          <%= score_f.label :score, score_obj.template_item.title, class: "text-sm text-[#4e342e] leading-tight cursor-pointer group-hover:text-[#d32f2f] transition-colors" %>
                        </li>
                      <% end %>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            </div>
          </div>

          <%# 送信ボタン (シーリングスタンプ風) %>
          <div class="text-center mt-4 relative group">
            <%= f.button type: "submit", class: "relative z-10 inline-flex flex-col items-center justify-center w-24 h-24 rounded-full bg-[#b71c1c] text-[#ffcdd2] shadow-[0_4px_0_#7f0000,0_10px_10px_rgba(0,0,0,0.3)] border-4 border-[#e57373] border-dashed hover:bg-[#c62828] hover:translate-y-1 hover:shadow-[0_2px_0_#7f0000,0_5px_5px_rgba(0,0,0,0.3)] transition-all duration-200 outline-none" do %>
              <span class="text-2xl">✉️</span>
              <span class="text-[10px] font-bold tracking-widest uppercase mt-1">送信</span>
            <% end %>
            
            <%# 蝋の垂れ装飾 %>
            <div class="absolute top-[-5px] left-1/2 transform -translate-x-1/2 w-28 h-28 bg-[#b71c1c] rounded-full opacity-20 blur-md z-0 group-hover:opacity-30 transition"></div>
          </div>

        </div>
      </div>

    <% end %>
  </div>
</div>

<%# スクロールバーのスタイル調整 %>
<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #efebe9;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #8d6e63;
    border-radius: 3px;
  }
</style>