<%# 評価フォーム専用: 背景を白に設定 %>
<% content_for :body_class, "bg-white" %>

<div class="container mx-auto px-4 py-8 max-w-5xl">
  
  <%# 戻るボタン %>
  <div class="mb-6 text-left">
    <%= link_to dashboard_path, class: "inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full shadow-sm hover:bg-gray-300 transition duration-150 text-sm" do %>
      <i class="fas fa-arrow-left mr-2"></i> ダッシュボードに戻る
    <% end %>
  </div>
  
  <h1 class="text-3xl font-extrabold text-indigo-700 mb-2 text-center">大人のサンタさん通知レター</h1>
  <p class="text-center text-gray-500 mb-10 text-lg">感謝のメッセージと、相手の優れた点をまとめてお届けしましょう!</p>

  <%= form_with model: @evaluation, url: evaluations_path, local: true, class: "evaluation-form" do |f| %>

    <%# エラーメッセージ表示ブロック (Tailwindスタイル) %>
    <% if @evaluation.errors.any? %>
      <div class="p-4 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md" role="alert">
        <h4 class="font-bold text-lg mb-1">送信に失敗しました</h4>
        <ul class="list-disc ml-5 space-y-1 text-sm">
          <% @evaluation.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%# テンプレートIDの保持 %>
    <%= f.hidden_field :template_id, value: @template&.id %>

    <%= f.hidden_field :evaluated_user_id, value: @receiver.id %>

    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-10 border border-gray-100">

      <%# 評価対象の表示 (固定表示) %>
      <div class="mb-6">
        <label class="block text-xl font-bold text-gray-700 mb-2">お手紙を送る相手 (必須/自動挿入)</label>
        <div class="mt-1 block w-full pl-4 pr-10 py-3 text-lg border border-gray-300 bg-gray-50 rounded-lg shadow-inner font-semibold text-gray-800">
          <%= @receiver.username %>
        </div>
      </div>

      <%# 評価メッセージ %>
      <div class="mb-10">
        <%= f.label :message, "感謝のメッセージ (必須)", class: "block text-xl font-bold text-gray-700 mb-2" %>
        <%= f.text_area :message, 
                        class: "shadow-sm focus:ring-red-500 focus:border-red-500 mt-1 block w-full text-lg border border-gray-300 rounded-lg p-4", 
                        rows: 5, 
                        placeholder: "感謝の言葉や、具体的なエピソードを添えてください。" %>
      </div>

      <%# 評価項目リスト - 2段組 %>
      <h2 class="text-2xl font-extrabold text-indigo-700 mb-6 border-b-2 border-indigo-100 pb-3">
        相手の優れた点をチェックしてください 
        <% if @evaluation.errors[:base].present? %>
          <span class="text-red-500 text-sm">(<%= @evaluation.errors[:base].to_sentence %>)</span>
        <% else %>
          <span class="text-gray-500 text-base font-normal">(最低1つ必須)</span>
        <% end %>
      </h2>

      <%# Tailwind Grid 2段組 %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <%# @evaluation.evaluation_scoresをループさせ、template_itemのcategoryでグループ化 %>
        <% @evaluation.evaluation_scores.group_by { |es| es.template_item.category }.each do |category, scores| %>
          <div class="col-span-1">
            <%# カードデザインを適用 %>
            <div class="p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-md h-full transition duration-300 hover:shadow-lg">
              <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2"><%= category %></h3>
              
              <ul class="list-none space-y-4">
                <% scores.each_with_index do |score_obj, index| %>
                  <% template_item = score_obj.template_item %>
                  <li class="flex items-start">
                    
                    <%# fields_forを使用してネストされたEvaluationScoreを扱う %>
                    <%# コレクション全体に対して fields_for を適用 %>
                    <%= f.fields_for :evaluation_scores, score_obj do |score_f| %>
                      
                      <%= score_f.hidden_field :id %>
                      <%= score_f.hidden_field :template_item_id %>
                      
                      <%# Tailwindの大きなチェックボックスとラベルの配置 %>
                      <div class="flex items-center">
                        <%= score_f.check_box :score, 
                                              { class: "h-6 w-6 text-red-600 border-gray-300 rounded focus:ring-red-500 cursor-pointer mt-1" }, 
                                              '1',    # true_value
                                              '0'     # false_value
                        %>
                        <%# ラベルの文字を大きく (text-lg) %>
                        <%= score_f.label :score, template_item.title, class: "ml-3 text-lg font-medium text-gray-700 select-none cursor-pointer" %>
                      </div>
                      
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%# 送信ボタン (w-full, md:w-1/2に変更して横長に対応) %>
    <div class="text-center mt-12">
      <%= f.submit "サンタさんからのお手紙を送信する", 
        class: "w-full md:w-1/2 px-6 py-3 border border-transparent text-xl font-bold rounded-full shadow-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 cursor-pointer mx-auto block" %>
    </div>
  <% end %>
</div>