<div class="container mx-auto px-4 py-12 max-w-4xl">
<%# 評価メッセージのタブ切り替え %>
<div class="flex justify-center mb-8">
<div class="flex bg-gray-100 rounded-xl p-1 shadow-inner">
<button id="received-tab"
class="tab-button px-6 py-2 text-sm font-semibold rounded-lg transition duration-150 ease-in-out <%= 'bg-white text-indigo-600 shadow' if params[:tab].blank? || params[:tab] == 'received' %>"
onclick="window.location.href = '<%= evaluations_path(tab: 'received') %>'">
もらったお手紙
(<%= @received_evaluations.count %>)
</button>
<button id="sent-tab"
class="tab-button px-6 py-2 text-sm font-semibold rounded-lg transition duration-150 ease-in-out <%= 'bg-white text-indigo-600 shadow' if params[:tab] == 'sent' %>"
onclick="window.location.href = '<%= evaluations_path(tab: 'sent') %>'">
送ったお手紙
(<%= @sent_evaluations.count %>)
</button>
</div>
</div>
<%# メッセージリスト %>
<div class="space-y-4">
<%
is_received = params[:tab].blank? || params[:tab] == 'received'
evaluations_to_display = is_received ? @received_evaluations : @sent_evaluations
title = is_received ? 'もらったお手紙' : '送ったお手紙'
%>
<h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-6">
  <%= title %>
</h2>

<% if evaluations_to_display.any? %>
  <% evaluations_to_display.each do |evaluation| %>
    <%
      # 関連するローカル変数を全てここで定義
      # カードの背景色を決定
      card_bg_color = is_received ? 'bg-red-50' : 'bg-green-50'
      
      # モデルのアソシエーション名（evaluator/evaluated_user）を使用
      target_user = is_received ? evaluation.evaluator : evaluation.evaluated_user
      label_text = is_received ? '送信者' : '受信者'

      # usernameの取得とnilガードを分離し、ローカル変数に格納
      target_username = target_user&.username || '不明なユーザー'
    %>

    <div class="p-5 <%= card_bg_color %> rounded-xl shadow-md transition duration-300 hover:shadow-lg border border-gray-200">
      <div class="flex justify-between items-start mb-2">
        
        <%# メッセージタイトルと相手の名前 - 文字色を黒に固定 %>
        <div>
          <h3 class="text-lg font-bold text-gray-900 mb-1">
            <%= is_received ? 'あなたへのお手紙' : '送信済みのお手紙' %>
          </h3>
          <p class="text-sm text-gray-700">
            <%= label_text %>: 
            <span class="font-semibold text-gray-900">
              <%# 定義したローカル変数 target_username を使用 %>
              <%= target_username %>
            </span>
          </p>
        </div>
        
        <%# 日付 %>
        <div class="text-right flex-shrink-0">
          <p class="text-xs text-gray-500">
            <%= l evaluation.created_at, format: :short %>
          </p>
        </div>
      </div>
      
      <p class="text-gray-700 mb-3 line-clamp-2">
        <%= evaluation.message.presence || "メッセージ本文がありません" %>
      </p>
      
      <%# 詳細ボタン %>
      <div class="text-right">
        <%= link_to '詳細を見る', evaluation_path(evaluation), 
            class: 'inline-flex items-center text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition duration-150' %>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="text-center py-12 bg-white rounded-xl shadow-lg border border-gray-100">
    <p class="text-lg font-semibold text-gray-500">
      まだ<%= title %>はありません。
    </p>
    <p class="text-sm text-gray-400 mt-1">
      お手紙を送って、フィードバックを交換しましょう。
    </p>
  </div>
<% end %>

</div>
</div>